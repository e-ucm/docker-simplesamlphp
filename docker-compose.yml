version: '3.7'

networks:
  default:
    ipam:
      driver: default
      config:
        - subnet: "172.31.0.53/24"

services:
# https://medium.com/@containeroo/traefik-2-0-paranoid-about-mounting-var-run-docker-sock-22da9cb3e78c
  socket-proxy:
    image: tecnativa/docker-socket-proxy
    hostname: socket-proxy.internal.test
    networks:
      default:
        aliases:
          - socket-proxy.internal.test
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
#      LOG_LEVEL: "debug"
      LOG_LEVEL: "${DOCKER_SOCKET_PROXY_LOG_LEVEL:-info}"
# https://github.com/BretFisher/dogvscat/blob/master/stack-proxy-global.yml#L124    
      NETWORKS: 1
      #SERVICES: 1
      CONTAINERS: 1
      #SWARM: 1
      #TASKS: 1

  dns-proxy-server:
    image: eucm/dns-proxy-server:2.19.0-dh-2
    hostname: dns.internal.test
    depends_on:
      - socket-proxy
    environment:
#      MG_LOG_LEVEL: "DEBUG"
      MG_LOG_LEVEL: "INFO"
      MG_DOCKER_HOST: "tcp://socket-proxy.internal.test:2375"
      MG_DOCKER_API_VERSION: "v1.24"
    networks:
      default:
        ipv4_address: 172.31.0.53
        aliases:
          - dns.internal.test
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.dns.loadbalancer.server.port=5380"
      - "traefik.http.routers.dns.rule=Host(`dns.external.test`)"
      - "traefik.http.routers.dns.entrypoints=websecure"
      - "traefik.http.routers.dns.tls=true"

  reverse-proxy:
    image: traefik:2.2
    entrypoint:
      - sh
      - '-c'
      - |
        mkdir -p /etc/traefik/conf/dynamic-config;
        cat << EOF > /etc/traefik/conf/dynamic-config/file-provider.toml
        [[tls.certificates]]
          certFile = "/etc/traefik/ssl/cert.crt"
          keyFile = "/etc/traefik/ssl/cert.key"
          stores = ["default"]

        [tls.stores]
          [tls.stores.default]
            [tls.stores.default.defaultCertificate]
              certFile = "/etc/traefik/ssl/cert.crt"
              keyFile  = "/etc/traefik/ssl/cert.key"

        [tls.options]
          [tls.options.default]
            minVersion = "VersionTLS12"
          [tls.options.myTLSOptions]
            minVersion = "VersionTLS13"
        
        [http.middlewares]
          [http.middlewares.dashboardAuth.basicAuth]
            # admin:password
            users = [
              "admin:\$$apr1\$$97xk9Kkr\$$gavbmzhrI6uOVYNOfYByQ/"
            ]
          [http.middlewares.redirect-to-https.redirectScheme]
            scheme = "https"
            permanent = true
        EOF
        exec traefik "$$@"
    command:
      - ""
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.http.tls=true
      - --global.checkNewVersion=false
      - --global.sendAnonymousUsage=false
      - --serversTransport.insecureSkipVerify=true
      - --api.dashboard=true
      - --providers.file.directory=/etc/traefik/conf/dynamic-config
      - --providers.file.watch=true
      - --providers.docker=true
      - --providers.docker.exposedByDefault=false
      - --providers.docker.endpoint=tcp://socket-proxy.internal.test:2375
      - --providers.docker.watch=true
      - --providers.docker.defaultRule=Host(`{{ .Name }}.external.test`)
      - --log.level=DEBUG
      - --log.format=json
    volumes:
      - "./ssl:/etc/traefik/ssl:ro"
    hostname: traefik.internal.test
    dns:
      - 172.31.0.53
    depends_on:
      - socket-proxy
      - dns-proxy-server
    labels:
      - "traefik.enable=true"
# Global redirect http to https
      - "traefik.http.routers.http-catchall.entrypoints=web"
      - "traefik.http.routers.http-catchall.rule=HostRegexp(`{host:.+}`)"
      - "traefik.http.routers.http-catchall.middlewares=redirect-to-https@file"
      # Access API enpoint through traefik itself
      - "traefik.http.services.api.loadbalancer.server.port=8080"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.external.test`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.tls.options=myTLSOptions@file"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=dashboardAuth@file"
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: tcp
        mode: host 
    networks:
      default:
        aliases:
          - traefik.internal.test

  simplesamlphp:
#    build:
#      context: ./docker
    image: eucm/simplesamlphp:1.18.7
#    entrypoint: /bin/bash
#    command: /bin/bash
#    stdin_open: true
#    tty: true
    depends_on:
      - dns-proxy-server
    environment:
      DEBUG: "true"
      SIMPLESAMLPHP_PATH: "/simplesamlphp"
      SIMPLESAMLPHP_ADMIN_PASSWORD: "admin"
      SIMPLESAMLPHP_LOG_LEVEL: "DEBUG"
      SIMPLESAMLPHP_ENABLE_DEFAULT_VHOST: "true"
      SIMPLESAMLPHP_INTERNAL_PROXY_HOSTNAME: "traefik.internal.test"
      MSMTP_HOST: "mail.internal.test"
      MSMTP_FROM: "no-reply@simplesamlphp.external.test"

    hostname: simplesamlphp.internal.test
    dns:
      - 172.31.0.53
    networks:
      default:
        aliases:
          - "simplesamlphp.internal.test"
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.simplesamlphp.loadbalancer.server.port=80"
      - "traefik.http.routers.simplesamlphp.rule=Host(`simplesamlphp.external.test`)"
      - "traefik.http.routers.simplesamlphp.entrypoints=websecure"
      - "traefik.http.routers.simplesamlphp.tls=true"

  mail:
    image: maildev/maildev:1.1.0
    hostname: mail.simplesamlphp.dev.test
    depends_on:
      - dns-proxy-server
    environment:
      MAILDEV_SMTP_PORT: 25
      MAILDEV_WEB_PORT: 80
    dns:
      - 172.31.0.53
    networks:
      default:
        aliases:
          - "mail.internal.test"
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.mail.loadbalancer.server.port=80"
      - "traefik.http.routers.mail.rule=Host(`mail.external.test`)"
      - "traefik.http.routers.mail.entrypoints=websecure"
      - "traefik.http.routers.mail.tls=true"